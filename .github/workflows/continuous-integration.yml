name: Continous Integration

on:
  workflow_call:
    secrets:
      NPM_USER:
        description: 'repository NPM_USER secret passed on'
        required: true
      NPM_PASS:
        description: 'repository NPM_PASS secret passed on'
        required: true
      NPM_EMAIL:
        description: 'repository NPM_EMAIL secret passed on'
        required: true    

jobs:
  setup_environment:
    name: Setup environment
    runs-on: ubuntu-latest
    steps: 
      - uses: vuestorefront/integrations-github-workflows/.github/actions/setup-environment
        with:
          NPM_EMAIL: ${{ secrets.NPM_EMAIL }}
          NPM_USER: ${{ secrets.NPM_USER }}
          NPM_PASS: ${{ secrets.NPM_PASS }}
  
  eslint-staged:
    name: Eslint Staged
    needs: setup_environment
    runs-on: ubuntu-latest
    steps:
      - uses: vuestorefront/integrations-github-workflows/.github/actions/setup-environment
        with:
          NPM_EMAIL: ${{ secrets.NPM_EMAIL }}
          NPM_USER: ${{ secrets.NPM_USER }}
          NPM_PASS: ${{ secrets.NPM_PASS }}
      - name: Run linter on changed files ðŸ§¹
        uses: tj-actions/eslint-changed-files@v18
        with:
          config_path: "./.eslintrc.json"
          ignore_path: "./.eslintignore"
          token: ${{ secrets.GITHUB_TOKEN }}
          file_extensions: |
            **/*.ts
            **/*.vue
            
  circular-dependencies:
    name: Circular dependencies
    needs: setup_environment
    runs-on: ubuntu-latest   
    steps:
      - uses: vuestorefront/integrations-github-workflows/.github/actions/setup-environment
        with:
          NPM_EMAIL: ${{ secrets.NPM_EMAIL }}
          NPM_USER: ${{ secrets.NPM_USER }}
          NPM_PASS: ${{ secrets.NPM_PASS }}
      - name: Detect circular dependencies ðŸ”„
        uses: vuestorefront/engineering-toolkit/github-actions/circular-dependencies@1.0.3
        with:
          filesPath: 'packages/**/*.{ts,vue}'
          
  check-licenses:
    name: Check licenses
    needs: setup_environment
    runs-on: ubuntu-latest   
    steps:      
      - uses: vuestorefront/integrations-github-workflows/.github/actions/setup-environment
        with:
          NPM_EMAIL: ${{ secrets.NPM_EMAIL }}
          NPM_USER: ${{ secrets.NPM_USER }}
          NPM_PASS: ${{ secrets.NPM_PASS }}   
      - name: Check licenses ðŸ§ª
        uses: vuestorefront/engineering-toolkit/github-actions/check-licenses@1.0.5
        with:
          projectPath: ${{ github.workspace }}
